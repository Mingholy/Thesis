\chapter{基于神经网络的中文序列标注模型}
\section{词的分布式表示}
\section{循环神经网络与长短时记忆网络}
\subsection{循环神经网络}
\subsection{长短时记忆网络及其变体}
虽然除$t_0$时刻的RNN单元外后续的每个单元接收的输入都带有之前所有时刻信息的累积，但受限于梯度消失问题，相隔较远的时刻输入对参数学习将不会有贡献，导致时域上靠后的单元无法很好地感知靠前的单元，句子内的长程依赖信息就无法被学习。针对这一问题，S.Hochreiter和J.Schmidhuber在1997年提出了LSTM，其本质是使用带有信息存储和更新机制的单元代替RNN中一般的激活单元。信息存储即cell的内部状态，而更新机制则通过一系列“门”实现，包括输入门$i_t$、遗忘门$f_t$和输出门$o_t$。
一个基本的LSTM实现如图所示。其内部参数可表达为：
\begin{align*}
    \Vector{i_t} &= \sigma(\Matrix{W_{hi}}\Vector{h_{t-1}} + \Matrix{W_{xi}}\Vector{x_{t}} + \Vector{b_i})\\
    \Vector{f_t} &= \sigma(\Matrix{W_{hf}}\Vector{h_{t-1}} + \Matrix{W_{xf}}\Vector{x_{t}} + \Vector{b_f})\\
    \Vector{o_t} &= \sigma(\Matrix{W_{ho}}\Vector{h_{t-1}} + \Matrix{W_{xo}}\Vector{x_{t}} + \Vector{b_o})\\
    \Vector{C_t} &= \Vector{f_t}\odot\Vector{C_{t-1}} + \Vector{i_t}\odot tanh(\Matrix{W_{Ch}}\Vector{h_{t-1}} + \Matrix{W_{Cx}}\Vector{x_t} + \Vector{b_{C}})\\
    \Vector{h_t} &= \Vector{o_t} \odot tanh(\Vector{C_t})
\end{align*}
其中$\odot$代表元素乘积，其结果仍是一个高维实向量。
根据该描述可知，对于某时刻的输入，LSTM层在得到输出之前，
首先对cell中存储的历史信息$C_{t-1}$进行了处理，通过遗忘门层$f_t$根据上一时刻隐层输出$h_{t-1}$与当前时刻的输入$x_t$，
控制cell状态中哪些信息将得到保留；
随后再将更新后的cell状态的激活值与输出门层$o_t$结合得到当前时刻的隐层状态传递下去。
文献[]给出了LSTM cell的一个改进版本，它在原有LSTM结构的基础上增加了cell状态对遗忘信息的影响，
称为peep-hole，即在图[]所示LSTM结构基础上增加虚线部分。
其内部参数可表示为：
\begin{align*}
    \Vector{i_t} &= \sigma(\Matrix{W_{hi}}\Vector{h_{t-1}} + \Matrix{W_{xi}}\Vector{x_{t}} + \Matrix{W_{Ci}}\Vector{C_{t-1}} + \Vector{b_i})\\
    \Vector{f_t} &= \sigma(\Matrix{W_{hf}}\Vector{h_{t-1}} + \Matrix{W_{xf}}\Vector{x_{t}} + \Matrix{W_{Cf}}\Vector{C_{t-1}} + \Vector{b_f})\\
    \Vector{o_t} &= \sigma(\Matrix{W_{ho}}\Vector{h_{t-1}} + \Matrix{W_{xo}}\Vector{x_{t}} + \Matrix{W_{Co}}\Vector{C_{t-1}} + \Vector{b_o})\\
    \Vector{C_t} &= \Vector{f_t}\odot\Vector{C_{t-1}} + \Vector{i_t}\odot tanh(\Matrix{W_{Ch}}\Vector{h_{t-1}} + \Matrix{W_{Cx}}\Vector{x_t} + \Vector{b_{C}})\\
    \Vector{h_t} &= \Vector{o_t} \odot tanh(\Vector{C_t})
\end{align*}
在上述使用peep-hole的LSTM cell的基础上，
文献[]在命名实体识别任务上还使用了耦合输入-遗忘门（Coupled Input-Forget Gate, CIFG）[]取得了较好的效果，
即令$\Vector{f_t} = 1 - \Vector{i_t}$，对比LSTM cell简化了CIFG的计算:
\begin{equation*}
    \Vector{C_t} = (1 - \Vector{i_t})\odot \Vector{C_{t-1}} + \Vector{i_t}\odot tanh(\Matrix{W_{Cx}}\Vector{x_t} + \Matrix{W_{ch}}\Vector{h_{t-1}} + \Vector{b_C})
\end{equation*}
最后，文献[]提出了一种更为简单的LSTM单元的变体，称为门控循环单元(Gated Recurrent Unit，GRU)。
GRU存在多种变体，区别在于计算每个门层输出是否使用之前的隐藏状态和偏置。
本节使用的GRU仅使用隐藏状态计算门层输出，如图3所示。
其最主要的特征是
\begin{enumerate}
    \item 融合了cell状态和隐藏层输出
    \item 融合了输入门和遗忘门
\end{enumerate}
这使得单元相比LSTM更加简单，参数更少，同时实验表明它能够在大部分任务中取得与LSTM相当或更佳的效果。
其内部参数可表示为：
\begin{align*}
    \Vector{z_t} &= \sigma(\Matrix{W_{zx}}\Vector{x_t} + \Matrix{W_{zh}}\Vector{h_{t-1}})\\
    \Vector{r_t} &= \sigma(\Matrix{W_{rx}}\Vector{x_t} + \Matrix{W_{rh}}\Vector{h_{t-1}})\\
    \Vector{\tilde{h_t}} &= tanh(\Matrix{W_{\tilde{h}u}}(\Vector{r_t} \odot \Vector{h_{t-1}}) + \Matrix{W_{\tilde{h}x}}\Vector{x_t})\\
    \Vector{h_t} &= (1 - \Vector{z_t}) \odot \Vector{h_{t-1}} + \Vector{z_t} \odot \Vector{\tilde{h_t}}
\end{align*}

\section{基于Bi-LSTM-CRF的医案症状术语识别}
\subsection{引言}
中医典籍和医案是中国传统医学宝贵的知识财富。
中医医案经历了长时间的积累，记载了古今众多医者的实证经验和临床诊疗规律。
这些医案中存在大量的症状信息，这些信息对医者辩证论治、察明证素，进而对证施治起着至关重要的作用；
同时，症状、治法、处方、剂量与预后疗效之间存在的内在联系，也能够反映中医对疾病的诊疗机理。
若要系统地研究这些诊疗机理，对医案进行结构化处理，挖掘医案文本，寻找其中蕴含的关联规则是一系列必要的任务。
在医案结构化处理任务中，首要的就是将中医医案文本中对症状具体的描述和长期以来形成的普遍使用的中医症状术语提取出来。

目前，针对中医医案文本中症状术语的识别存在几个难点。
首先，中医医案的结构化程度低。
具体表现为不同年代、不同地域的不同医家个体，其记录医案的结构和习惯均存在不同，导致无法按统一标准进行结构化。
其次，就医案内容而言，由于存在大量医案年代较为久远，其语言特点与现代汉语也存在较大差异，多为文言文或半文半白，识别难度较大。
最后，对于需要提取的目标症状描述或症状术语，缺乏统一的规范。
至今，中医临床常见症状术语尚未有国家标准，中医医案中口语化、症状实体包含、互指现象也十分普遍，加之症状描述本身形式灵活多变，这对识别症状的正确性、完整性提出了更高的要求。

识别中医医案文本中的症状描述或症状术语这一任务实际上就是从医案文本中进行症状实体识别，可以将其视为命名实体识别任务的一种。
目前对于中医医案症状识别主要使用条件随机场（Conditional Random Field, CRF）方法。
文献[]从命名实体识别的方法出发，对比了CRF与支持向量机、最大熵模型等常见的命名实体识别方法，指出了CRF在该任务上的有效性，但同时也存在依赖分词和词性标注效果、对超过五个字符的较长实体识别效果较差等局限性。
文献[]对比了CRF、隐马尔科夫模型和最大熵隐马模型在特定病种的标准病历数据集上对症状、疾病和诱因的识别效果。
文献[]-[]均采用了CRF方法针对中医领域的文本语料进行命名实体识别，以进行医案结构化、症状等中医术语提取等工作。

本节针对CRF方法特征选择相对复杂，人工标注特征代价相对较高，对语料结构化、标准化程度依赖较大等局限性，提出使用结合神经网络的序列标注框架，
在以文言文本为主的近代中医医案典籍上进行中医症状术语识别，并根据症状组成要素，添加简单的字符级别特征，在增加较少人工标注成本的前提下，获得更佳的症状识别效果。
本节将使用不同的LSTM结构进行实验，并对比分析不同结构对实验结果的影响。

\subsection{双向LSTM-CRF序列标注框架}
单向LSTM能够较好地获取上文信息，使得句子中的历史依赖特征可以保留下来。
对于一个可能含有症状术语的文本序列$\Tensor{X}$，其$t$时刻的输入为$\Vector{x_t}$，$x_t$为文本序列中单个文字对应的特征向量。
在未加入症状字特征时，该特征向量为该文字对应的字向量。
将字向量序列按顺序输入，则LSTM层在$t$时刻的隐层输出$\Vector{\overrightarrow{h_t}}$代表根据包含了上文特征语义信息和当前时刻输入信息得到的字向量表示。
但传统中医医案中对于症状的描述出现的范围包括证候、诊断（包括复诊、三诊等）、预后疗效、病案分析。
判定文本序列的某个子序列是典型的症状术语，需要同时考虑上下文携带的信息。
同理，使用另一个结构相同但参数独立的LSTM层，反向输入给定序列则可得到根据后文特征得到的字向量表示$\Vector{\overleftarrow{h_t}}$。
将这两部分字向量表示拼接可以得到包含上下文信息的字向量表示$\Vector{h_t} = [\Vector{\overrightarrow{h_t}}, \Vector{\overleftarrow{h_t}}]$。

双向LSTM-CRF序列标注框架中，Bi-LSTM层用来整合提取输入序列的特征，将字向量结合上下文语义信息扩展为向量表示，并在其输出层采用Softmax函数将隐层输出映射到标签集上的概率分布向量。
文本序列输入完毕后，LSTM层的最终输出为序列中每个字符所述标签的概率分布矩阵。最后，使用CRF层根据LSTM层得到的概率分布矩阵，在所有可行的标签序列空间中确定一个最合理的序列路径，此时序列中每个标签对应的即是相同位置上的字符标签。

\subsection{基于症状要素的字特征}
考虑到中医症状实体本身还具有很多明显的特征，以这些特征作为锚点，能够快速准确地定位一些出现比较频繁的症状。
但同时也存在小部分负例，应以文本序列出现的上下文信息判断是否是症状。
为了考察这些特征对症状识别结果的影响，本节进行了如表1所示下的特征标签分类。
对于文本序列中的单字，模型使用预训练的字嵌入作为基本特征；额外的症状术语单字，将采用随机初始化获得其表示其标签类型的嵌入向量，与字嵌入连接作为该字符的表示。
表1所示特征，仅为对标准化的症状词典进行简单的字符频率统计并按照字符表意类型进行分类得到的常见额外字特征。
\begin{table}[!htbp]
    \centering
    \footnotesize
    \setlength{\tabcolsep}{4pt}
    \renewcommand{\arraystretch}{1.2}
    \begin{tabular}{cp{7cm}c}
        \hline\hline
        特征种类 & 部分特征关键字 & 特征标签\\
        \hline
        自感特征 & 疼、痛、肿、胀、酸、麻 & SF(self feeling)\\
        \hline
        身体部位 & 脉、左、右、寸、关、尺、舌、苔、手、身、口、目、眼、耳、足、胸、额、头、脘、腹、唇、齿、胃、面、颊、肢 & BP(body parts)\\
        \hline
        颜色形态 & 白、赤、红、滑、腻、溏、稀、干、燥、朱、黑、青、紫、绛、焦、黄 & CS(color shape)\\
        \hline
        程度描述 & 稍、微、略、甚、强、大、多、少、无、极、弱 & AD(adverbs of degree) \\
        \hline
        排泄物名词 & 便、溲、痰、汗 & EC(ecreta)\\
        \hline\hline
    \end{tabular}
    \caption{症状字特征分类}
\end{table}

上述特征均是字符级别。
为了不增加训练语料的人工标注成本，可以在训练语料中进行简单的单字替换获得，作为单独的特征列输入模型。
最终的标注结果示例如图5所示。

本节将单字特征和预训练的字嵌入进行连接获得的新的字向量表示作为模型输入，这些额外特征将作为字嵌入的扩展，为模型提取特征从而进行症状术语识别提供更具体有效的信息。


\subsection{实验设计}
本节使用的数据集来自中医典籍《全国名医验案类方》，作者为近代名医何廉臣，共计492例医案。
原医案语料已具有一定的结构特征，单个医案中划分了病因、证候、诊断、疗法等不同项目，但也存在包括医者、病者等无关信息，本节只选取其中证候、诊断、疗法、效果及作为医案评述的“廉按”部分内容作为原始语料，共2959条语料。
由于典籍中的医案是医者行医记录，虽然在医者已按照既定结构记载，但这些项目中仍存在大量描述和推断，不能完全作为症状实体。
且记录医案存在一定随意性，症状实体在证候、诊断、疗法、效果和医案评述中均可能出现，故对所有语料参考《中医临床症状术语规范》中六大类37小类共2069条规范症状进行标注。
考虑到原始语料年代较为久远，部分症状描述可能与现代汉语存在差异，故酌情对语料中频繁出现的部分症状进行了补充标注。
需要说明的是，文献[1]和[4]的工作已经表明，对于中医医案尤其是使用古代汉语的中医医案语料，对其进行分词效果并不好，因为现有的分词工具多倾向于将无法识别的词语进行单字切分，若以词为粒度进行识别，分词会对结果产生负面影响。
因此本节利用字符级别特征进行序列标注，对所有语料进行单字切分，并按照BIO标准进行标注，即症状实体起始字标签为“B”，症状实体非起始字为“I”，非症状实体字为“O”。
由于实验语料规模较小，故本节选取其中30例医案作为测试语料，剩余语料作为训练数据，其中训练集与验证集比例为9:1。
最后，本节使用Gensim工具利用全部中医医案语料作为训练数据，获得了预训练的字嵌入作为基本特征，字嵌入维度设置为100，基于症状要素的字特征嵌入维度设置为30。
本节基于是否加入症状字特征和多种LSTM cell实现进行对比实验。实验结果基于标签进行评估。

本节使用隐藏层单元数量为64的双向LSTM，训练语料句子长度最大不超过100个字符。
为防止过拟合，建立模型时对SLTM的输入层和隐藏层进行随机dropout，保留概率均设置为0.8。
同时，全连接层L2正则化参数为0,001，全局学习率为0.002。



\section{本章小结}

本章在基于LSTM-CRF序列标注模型的基础上，针对中医症状特征添加了部分字符级别的要素特征，在小规模以古汉语为主的中医医案语料上的实验表明，该模型泛化能力更强，且对较长实体的识别效果更好。
同时，由于中医症状种类繁多，加之古汉语精干灵活的语言特点，该方法也存在召回率较低的缺点。
因此后续工作将围绕以下几点展开：第一，比较多种不同的标签模式对症状术语识别的效果影响；第二，由于部分症状描述分散于多个短语中，并且存在大量比较（如“六脉俱缓，左关尤甚”）、持续（如“继则全体大热，昼夜不休”）等特征，寻找有效方法利用这些特征也至关重要；最后还需考虑参照症状字典对不标准的症状描述进行聚类，识别时按照标准症状建立自然语言序列与症状的映射关系，便于以后对古医案的结构化。
